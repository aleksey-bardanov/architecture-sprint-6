# Задание 3

## Проблемы существующего решения

Текущая диаграмма контейнеров сервиса представлена в файле [InsureTech_C4_сontainer-diagram-as-is.drawio](./InsureTech_C4_сontainer-diagram-as-is.drawio)

Существующее решение имеет следующие проблемы:

- Сервис `ins-product-aggregator` использует синхронные запросы, чтобы собрать информацию обо всех тарифах, всех страховых компаний раз в 15 минут. Если хотя-бы один из сервисов партнеров не доступен данные о новых тарифах не будут переданы в `core-app`, а если сорвется запрос от `ins-comp-settlement`, это приведет к задержке передачи данных об оформленных страховках страховым фирмам
- Передача информации об оплаченных страховках происходит раз в сутки и зависит от бесперебойной работы 2-х внутренних сервисов сервисов и сервисов страховых компаний
- При расширении числа партнеров шанс сбоя передачи информации о платежах или неполучения актуальных данных о продуктах компаний увеличивается 
- Возможна рассинхронизация данных о тарифах между сервисами `core-app` и  `ins-comp-settlement`

## Предлагаемое решение

Диаграмма контейнеров предлагаемого решения представлена в файле [InsureTech_C4_сontainer-diagram-to-be.drawio](InsureTech_C4_сontainer-diagram-to-be.drawio)   

- Сервис `ins-product-aggregator` раз в 15 минут опрашивает сервисы страховых компаний и уведомляет остальные сервисы о текущих продуктах и тарифах, если какой-то из сервисов страховых компаний не доступен, данные о нем не включаются в сообщение, отправляемое в очередь
- Сервис `core-app` получает актуальные данные о текущих продуктах и тарифах и обновляет информацию в своей базе данных при необходимости
- При оформлении сделки `core-app` передает все необходимые для выставления счета данные в очередь
- Сервис `ins-comp-settlement` получает данные об оформлении страховки из очереди и записывает их в свою базу данных, а также делает запись в таблицу нотификации систем страховых компаний об оплате сделки (паттерн **transactional outbox**)
- Для уведомления страховых компаний о заключенных сделках сервис `ins-comp-settlement` периодически (зависит от того, как часто можно передавать данные страховым компаниям) вычитывает не переданные записи и уведомляет о них сервисы страховых компаний. Если уведомление успешно, запись помечается как переданная.